{% extends "layouts/base.html" %}

{% block body %}

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Robop Users</h1>
    <div class="d-flex">
      <button id="toggleEditBtn" class="btn btn-primary me-2">
        <i class="bi bi-pencil"></i> <span id="editBtnText">Enable Edit Mode</span>
      </button>
      <button id="refreshBtn" class="btn btn-secondary">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>

  <div id="editModeAlert" class="alert alert-info d-none">
    <i class="bi bi-info-circle"></i> Edit Mode: Click on any cell to edit. Press Enter to save, Esc to cancel.
  </div>

  <div id="saveStatus" class="alert d-none"></div>

  <!-- IMPORTANT: table-responsive wraps ONLY the table -->
  <div class="table-responsive">
    <table class="table table-striped dt-responsive nowrap" id="robopUserTable" style="width:100%">
      <thead>
        <tr>
          <th>ID</th>
          <th>UID</th>
          <th>First</th>
          <th>Last</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Created</th>
          <th>Last Login</th>

          <th>Badge Count</th>
          <th>Best Badge</th>
          <th>Best Score</th>
          <th>Best Sector</th>
          <th>Last Badge</th>
          <th>Last Earned</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for u in robop_user_data %}
        <tr id="robop-user-{{ u.id }}" data-id="{{ u.id }}">
          <td>{{ u.id }}</td>
          <td class="editable" data-field="uid">{{ u.uid }}</td>
          <td class="editable" data-field="first_name">{{ u.first_name }}</td>
          <td class="editable" data-field="last_name">{{ u.last_name }}</td>
          <td class="editable" data-field="email">{{ u.email or "" }}</td>

          <td class="editable" data-field="role">
            {% if u.role %}
              <span class="badge 
                {% if u.role == 'Admin' %}bg-danger
                {% elif u.role == 'moderator' %}bg-warning
                {% else %}bg-secondary{% endif %}">
                {{ u.role }}
              </span>
            {% else %}—{% endif %}
          </td>

          <td class="editable" data-field="status">
            {% if u.status %}
              <span class="badge 
                {% if u.status == 'active' %}bg-success
                {% elif u.status == 'inactive' %}bg-danger
                {% elif u.status == 'pending' %}bg-warning
                {% else %}bg-secondary{% endif %}">
                {{ u.status }}
              </span>
            {% else %}—{% endif %}
          </td>

          <td>{{ u.created or "—" }}</td>
          <td>{{ u.last_login or "—" }}</td>

          <td>{{ u.badge_count or 0 }}</td>
          <td class="editable" data-field="best_badge">{{ u.best_badge or "—" }}</td>
          <td class="editable" data-field="best_score">{{ u.best_score or "—" }}</td>
          <td class="editable" data-field="best_sector">{{ u.best_sector or "—" }}</td>
          <td class="editable" data-field="last_badge">{{ u.last_badge or "—" }}</td>
          <td>{{ u.last_earned or "—" }}</td>

          <td class="action-cell">
            <button class="btn btn-sm btn-danger delete-btn" data-id="{{ u.id }}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="mb-3">
            <label class="form-label">User ID *</label>
            <input type="text" class="form-control" name="uid" required>
          </div>
          <div class="mb-3">
            <label class="form-label">First Name *</label>
            <input type="text" class="form-control" name="first_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Last Name *</label>
            <input type="text" class="form-control" name="last_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select class="form-control" name="role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="moderator">Moderator</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-control" name="status">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveNewUserBtn">Save User</button>
      </div>
    </div>
  </div>
</div>

<style>
  .editable { cursor: pointer; position: relative; }
  .editable:hover { background-color: #f8f9fa; }
  .editable.editing { padding: 0; }
  .editable-input {
    width: 100%;
    border: 1px solid #0d6efd;
    padding: 6px;
    margin: -1px;
    border-radius: 4px;
  }
  .edit-mode .editable { background-color: #f0f8ff; }
  .action-cell { white-space: nowrap; }
  #saveStatus { transition: all 0.3s ease; }

  /* Pagination alignment + spacing */
  .dataTables_wrapper .dataTables_paginate .pagination {
    justify-content: flex-end;
    margin: 0;
  }
  .dataTables_wrapper .dataTables_info {
    padding-top: 0.5rem;
  }
</style>

<!-- ========= CSS (order matters) ========= -->
<!-- If your base.html already includes Bootstrap CSS, you can remove this line -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">

<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

<!-- ========= JS (order matters) ========= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables core FIRST -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<!-- Then Bootstrap integration -->
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- Then Responsive -->
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
  let isEditMode = false;
  let table = null;

  // Initialize DataTable (Responsive collapses columns instead of cutting off)
  table = $('#robopUserTable').DataTable({
    pageLength: 25,

    // IMPORTANT: use Responsive (no scrollX) so it keeps adapting
    responsive: {
      details: false   
    },
    autoWidth: false,

    dom:
      "<'row mb-2'<'col-12 col-md-6'l><'col-12 col-md-6'f>>" +
      "<'row'<'col-12'tr>>" +
      "<'row mt-2 align-items-center'<'col-12 col-md-5'i><'col-12 col-md-7'p>>",

    pagingType: "simple_numbers",

    // Collapse less important columns first
    columnDefs: [
      { responsivePriority: 1, targets: 15 }, // Actions
      { responsivePriority: 2, targets: 1 },  // UID
      { responsivePriority: 3, targets: 2 },  // First
      { responsivePriority: 4, targets: 3 },  // Last
      { responsivePriority: 5, targets: 0 },  // ID
      { responsivePriority: 100, targets: [7,8,9,10,11,12,13,14] } // timestamps/badges collapse early
    ]
  });

  // Force recalculation on resize so it keeps adapting at all widths
  $(window).on('resize', function () {
    table.columns.adjust().responsive.recalc();
  });

  // Toggle edit mode
  $('#toggleEditBtn').click(function() {
    isEditMode = !isEditMode;

    if (isEditMode) {
      $('#editBtnText').text('Disable Edit Mode');
      $('#toggleEditBtn').removeClass('btn-primary').addClass('btn-warning');
      $('#editModeAlert').removeClass('d-none');
      $('body').addClass('edit-mode');

      if (!$('#addUserBtn').length) {
        $('#toggleEditBtn').after(
          '<button id="addUserBtn" class="btn btn-success me-2"><i class="bi bi-person-plus"></i> Add User</button>'
        );
      }
    } else {
      $('#editBtnText').text('Enable Edit Mode');
      $('#toggleEditBtn').removeClass('btn-warning').addClass('btn-primary');
      $('#editModeAlert').addClass('d-none');
      $('body').removeClass('edit-mode');
      $('#addUserBtn').remove();
    }
  });

  // Refresh button
  $('#refreshBtn').click(function() {
    location.reload();
  });

  // Click cell to edit
  $(document).on('click', '.editable', function() {
    if (!isEditMode) return;

    const $cell = $(this);
    if ($cell.hasClass('editing')) return;

    const originalContent = $cell.html().trim();
    const field = $cell.data('field');
    const userId = $cell.closest('tr').data('id');

    $cell.data('original', originalContent);

    if (field === 'role' || field === 'status') {
      const currentValue = $cell.find('.badge').text().trim().toLowerCase() ||
                          (field === 'role' ? 'user' : 'active');

      let options = '';
      if (field === 'role') {
        ['user', 'admin', 'moderator'].forEach(role => {
          const selected = role === currentValue ? 'selected' : '';
          options += `<option value="${role}" ${selected}>${role.charAt(0).toUpperCase() + role.slice(1)}</option>`;
        });
      } else {
        ['active', 'inactive', 'pending'].forEach(status => {
          const selected = status === currentValue ? 'selected' : '';
          options += `<option value="${status}" ${selected}>${status.charAt(0).toUpperCase() + status.slice(1)}</option>`;
        });
      }

      $cell.html(`<select class="form-select form-select-sm editable-select" data-field="${field}" data-id="${userId}">${options}</select>`)
          .addClass('editing');
      $cell.find('select').focus();
    }
    else if (field === 'best_badge' || field === 'last_badge') {
      const badgeOptions = ['Gold', 'Silver', 'Bronze', 'Participant', '—'];
      let options = '';
      badgeOptions.forEach(badge => {
        const selected = originalContent === badge ? 'selected' : '';
        options += `<option value="${badge}" ${selected}>${badge}</option>`;
      });

      $cell.html(`<select class="form-select form-select-sm editable-select" data-field="${field}" data-id="${userId}">${options}</select>`)
          .addClass('editing');
      $cell.find('select').focus();
    }
    else if (field === 'best_score') {
      $cell.html(`<input type="number" min="0" max="100" class="editable-input" value="${originalContent}" data-field="${field}" data-id="${userId}">`)
          .addClass('editing');
      $cell.find('input').focus().select();
    }
    else if (field === 'best_sector') {
      $cell.html(`<input type="number" min="1" max="10" class="editable-input" value="${originalContent}" data-field="${field}" data-id="${userId}">`)
          .addClass('editing');
      $cell.find('input').focus().select();
    }
    else {
      $cell.html(`<input type="text" class="editable-input" value="${originalContent}" data-field="${field}" data-id="${userId}">`)
          .addClass('editing');
      $cell.find('input').focus().select();
    }
  });

  // Save edit (Enter key or blur)
  $(document).on('keydown blur', '.editable-input', function(e) {
    if (e.type === 'keydown' && e.which !== 13) return;

    const $input = $(this);
    const newValue = $input.val().trim();
    const $cell = $input.closest('.editable');
    const originalContent = $cell.data('original');
    const field = $input.data('field');
    const userId = $input.data('id');

    if (newValue !== originalContent && newValue !== '') {
      const badgeFields = ['best_badge', 'best_score', 'best_sector', 'last_badge'];
      if (badgeFields.includes(field)) {
        updateBadgeInfo(userId, field, newValue, $cell);
      } else {
        updateUser(userId, field, newValue, $cell);
      }
    } else {
      $cell.html(originalContent).removeClass('editing');
    }
  });

  // Save dropdown selection
  $(document).on('change blur', '.editable-select', function() {
    const $select = $(this);
    const newValue = $select.val();
    const $cell = $select.closest('.editable');
    const originalContent = $cell.data('original');
    const field = $select.data('field');
    const userId = $select.data('id');

    if (newValue !== originalContent) {
      const badgeFields = ['best_badge', 'best_score', 'best_sector', 'last_badge'];
      if (badgeFields.includes(field)) {
        updateBadgeInfo(userId, field, newValue, $cell);
      } else {
        updateUser(userId, field, newValue, $cell);
      }
    } else {
      $cell.html(originalContent).removeClass('editing');
    }
  });

  // Cancel edit (Esc)
  $(document).on('keydown', '.editable-input, .editable-select', function(e) {
    if (e.keyCode === 27) {
      const $input = $(this);
      const $cell = $input.closest('.editable');
      const originalContent = $cell.data('original');
      $cell.html(originalContent).removeClass('editing');
    }
  });

  function updateBadgeInfo(userId, field, value, $cell) {
    const data = {};
    data[field] = value;

    showStatus('Saving badge...', 'info');

    $.ajax({
      url: `/robop/api/users/${userId}/update_badge`,
      method: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function(response) {
        if (response.success) {
          showStatus('Badge updated successfully!', 'success');
          $cell.text(value);
        } else {
          showStatus('Error: ' + response.error, 'danger');
          $cell.html($cell.data('original'));
        }
        $cell.removeClass('editing');
      },
      error: function(xhr) {
        showStatus('Error saving badge: ' + (xhr.responseJSON?.error || xhr.statusText || 'Unknown error'), 'danger');
        $cell.html($cell.data('original')).removeClass('editing');
      }
    });
  }

  function updateUser(userId, field, value, $cell) {
    const data = {};
    data[field] = value;

    showStatus('Saving...', 'info');

    $.ajax({
      url: `/robop/api/users/${userId}`,
      method: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function(response) {
        if (response.success) {
          showStatus('Saved successfully!', 'success');

          if (field === 'role' || field === 'status') {
            const badgeClass = field === 'role' ?
              (value === 'admin' ? 'danger' : value === 'moderator' ? 'warning' : 'secondary') :
              (value === 'active' ? 'success' : value === 'inactive' ? 'danger' : 'warning');

            $cell.html(`<span class="badge bg-${badgeClass}">${value}</span>`);
          } else {
            $cell.text(value);
          }
        } else {
          showStatus('Error: ' + response.error, 'danger');
          $cell.html($cell.data('original'));
        }
        $cell.removeClass('editing');
      },
      error: function(xhr) {
        showStatus('Save error: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
        $cell.html($cell.data('original')).removeClass('editing');
      }
    });
  }

  function showStatus(message, type) {
    const $status = $('#saveStatus');
    $status.removeClass('d-none alert-info alert-success alert-danger')
          .addClass('alert-' + type)
          .html(`<i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'}"></i> ${message}`);

    if (type === 'success') {
      setTimeout(() => $status.addClass('d-none'), 3000);
    }
  }

  // Add user button
  $(document).on('click', '#addUserBtn', function() {
    $('#addUserForm')[0].reset();
    $('#addUserModal').modal('show');
  });

  // Save new user
  $('#saveNewUserBtn').click(function() {
    const formData = {
      uid: $('input[name="uid"]').val(),
      first_name: $('input[name="first_name"]').val(),
      last_name: $('input[name="last_name"]').val(),
      email: $('input[name="email"]').val(),
      role: $('select[name="role"]').val(),
      status: $('select[name="status"]').val()
    };

    $.ajax({
      url: '/robop/api/users',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(response) {
        if (response.success) {
          $('#addUserModal').modal('hide');
          showStatus('User added successfully!', 'success');
          setTimeout(() => location.reload(), 1000);
        } else {
          showStatus('Error: ' + response.error, 'danger');
        }
      },
      error: function(xhr) {
        showStatus('Add user error: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
      }
    });
  });

  // Delete user
  $(document).on('click', '.delete-btn', function() {
    if (!isEditMode) return;

    const userId = $(this).data('id');
    const userName = $(this).closest('tr').find('td:nth-child(3)').text() + ' ' +
                    $(this).closest('tr').find('td:nth-child(4)').text();

    if (confirm(`Are you sure you want to delete user: ${userName}?`)) {
      $.ajax({
        url: `/robop/api/users/${userId}`,
        method: 'DELETE',
        success: function(response) {
          if (response.success) {
            showStatus('User deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            showStatus('Error: ' + response.error, 'danger');
          }
        },
        error: function(xhr) {
          showStatus('Delete user error: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
        }
      });
    }
  });
});
</script>

{% endblock %}

{% block background %}
{% endblock %}
