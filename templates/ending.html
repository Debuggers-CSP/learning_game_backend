{% extends "layouts/base.html" %}

{% block head %}
<title>Ending Page</title>
{% endblock %}

{% block style %}
<style>
    .ending-container {
        max-width: 1100px;
        margin: 30px auto;
        padding: 24px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
    }
    .badge-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #f5f5f7;
        border: 1px solid #e0e0e0;
        border-radius: 999px;
        padding: 6px 14px;
        margin: 6px;
        font-weight: 600;
    }
    .code-box {
        background: #0b1020;
        color: #d4d7ff;
        border-radius: 12px;
        padding: 16px;
    }
    .code-box pre {
        margin: 0;
        white-space: pre-wrap;
    }
    .status-pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
    }
    .status-ok {
        background: #d1fae5;
        color: #065f46;
    }
    .status-bad {
        background: #fee2e2;
        color: #991b1b;
    }
    .guide-panel {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        min-height: 160px;
    }
    .guide-progress {
        height: 6px;
        background: rgba(148, 163, 184, 0.3);
        border-radius: 999px;
        overflow: hidden;
        margin-bottom: 12px;
    }
    .guide-progress > div {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #38bdf8, #22d3ee);
        transition: width 0.3s ease;
    }
    .guide-step {
        padding: 8px 10px;
        border-radius: 10px;
        margin-bottom: 8px;
        background: rgba(148, 163, 184, 0.12);
    }
    .guide-step.active {
        background: rgba(56, 189, 248, 0.25);
        border: 1px solid rgba(56, 189, 248, 0.6);
    }
    .chat-box {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        max-height: 260px;
        overflow-y: auto;
        background: #fafafa;
    }
    .chat-message {
        margin-bottom: 10px;
    }
    .chat-user {
        font-weight: 600;
        color: #1f2937;
    }
    .chat-ai {
        font-weight: 600;
        color: #2563eb;
    }
</style>
{% endblock %}

{% block body %}
<div class="ending-container">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Maze Complete</h2>
            <div class="text-muted">Player ID: {{ player_id }}</div>
        </div>
        <div id="completionStatus" class="status-pill status-bad">Not Completed</div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Final Score Summary</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-muted">Final Attempts</div>
                            <div id="finalAttempts" class="h4">-</div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted">Final Badge</div>
                            <div id="finalBadge" class="h4">-</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="text-muted">Completed At</div>
                        <div id="completedAt">-</div>
                    </div>
                    <div class="mt-3">
                        <div class="text-muted">Final Answer Correct</div>
                        <div id="finalCorrect">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Earned Badges</h5>
                    <div id="badgeList" class="mt-2">Loading...</div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Attempts & Timestamps</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Badge</th>
                                    <th>Attempts</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="attemptsTable">
                                <tr><td colspan="3">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Final Code Answer</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Final Attempts</label>
                            <input id="finalAttemptsInput" type="number" class="form-control" min="0" placeholder="e.g. 3">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Final Badge Name</label>
                            <input id="finalBadgeInput" type="text" class="form-control" placeholder="e.g. Champion">
                        </div>
                    </div>
                    <textarea id="finalAnswer" class="form-control" rows="6" placeholder="Paste your final code here..."></textarea>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button id="checkAnswer" class="btn btn-primary">Check Answer</button>
                        <button id="saveCompletion" class="btn btn-success">Save Completion</button>
                        <div id="checkStatus" class="ms-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">AI Walkthrough (No Full Code)</h5>
                    <p class="text-muted">Generate a guided, step-by-step explanation without revealing the full solution.</p>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button id="generateGuide" class="btn btn-outline-primary">Generate Walkthrough</button>
                        <button id="playGuide" class="btn btn-outline-secondary">Play Walkthrough</button>
                        <span id="guideStatus" class="text-muted"></span>
                    </div>
                    <div class="guide-panel" id="guidePanel">
                        <div class="guide-progress"><div id="guideProgress"></div></div>
                        <div class="text-muted">No walkthrough generated yet.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Ask the AI for Help</h5>
                    <div id="chatBox" class="chat-box mb-3"></div>
                    <div class="input-group">
                        <input id="chatInput" type="text" class="form-control" placeholder="Ask a question about the logic...">
                        <button id="chatSend" class="btn btn-primary">Send</button>
                    </div>
                    <small class="text-muted">The AI will guide you without giving the full answer.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pageData" data-player-id="{{ player_id }}" hidden></div>

<script>
    const playerId = document.getElementById("pageData").dataset.playerId;

    const badgeList = document.getElementById("badgeList");
    const attemptsTable = document.getElementById("attemptsTable");
    const completionStatus = document.getElementById("completionStatus");

    const finalAttempts = document.getElementById("finalAttempts");
    const finalBadge = document.getElementById("finalBadge");
    const completedAt = document.getElementById("completedAt");
    const finalCorrect = document.getElementById("finalCorrect");

    const finalAnswerInput = document.getElementById("finalAnswer");
    const finalAttemptsInput = document.getElementById("finalAttemptsInput");
    const finalBadgeInput = document.getElementById("finalBadgeInput");
    const checkAnswerBtn = document.getElementById("checkAnswer");
    const saveCompletionBtn = document.getElementById("saveCompletion");
    const checkStatus = document.getElementById("checkStatus");
    const generateGuideBtn = document.getElementById("generateGuide");
    const playGuideBtn = document.getElementById("playGuide");
    const guidePanel = document.getElementById("guidePanel");
    const guideStatus = document.getElementById("guideStatus");
    const guideProgress = document.getElementById("guideProgress");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const chatHistory = [];
    let guideSteps = [];
    let guideDurations = [];

    function formatTimestamp(ts) {
        if (!ts) return "-";
        const date = new Date(ts);
        return date.toLocaleString();
    }

    function renderScore(data) {
        const earnedBadges = data.earned_badges || [];
        badgeList.innerHTML = earnedBadges.length
            ? earnedBadges.map(b => `<span class="badge-pill">üèÖ ${b.badge_name}</span>`).join("")
            : "No badges earned yet.";

        attemptsTable.innerHTML = earnedBadges.length
            ? earnedBadges.map(b => `
                <tr>
                    <td>${b.badge_name || "-"}</td>
                    <td>${b.attempts}</td>
                    <td>${formatTimestamp(b.timestamp)}</td>
                </tr>
            `).join("")
            : '<tr><td colspan="3">No attempts logged yet.</td></tr>';

        const finalData = data.final || {};
        finalAttempts.textContent = finalData.final_attempts ?? "-";
        finalBadge.textContent = finalData.final_badge?.badge_name || "-";
        completedAt.textContent = formatTimestamp(finalData.completed_at);
        finalCorrect.textContent = typeof finalData.final_correct === "boolean"
            ? (finalData.final_correct ? "Yes" : "No")
            : "-";

        if (finalAttemptsInput && finalData.final_attempts !== null && finalData.final_attempts !== undefined) {
            finalAttemptsInput.value = finalData.final_attempts;
        }
        if (finalBadgeInput && finalData.final_badge?.badge_name) {
            finalBadgeInput.value = finalData.final_badge.badge_name;
        }

        if (data.completion_status) {
            completionStatus.textContent = "Completed";
            completionStatus.classList.remove("status-bad");
            completionStatus.classList.add("status-ok");
        } else {
            completionStatus.textContent = "Not Completed";
            completionStatus.classList.remove("status-ok");
            completionStatus.classList.add("status-bad");
        }
    }

    async function loadScore() {
        const response = await fetch(`/player/${playerId}/score`);
        const data = await response.json();
        if (data.success) {
            renderScore(data);
        }
    }

    checkAnswerBtn.addEventListener("click", async () => {
        checkStatus.textContent = "Checking...";
        const response = await fetch(`/player/${playerId}/final-check`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ answer: finalAnswerInput.value })
        });
        const data = await response.json();
        if (data.correct) {
            checkStatus.textContent = "‚úÖ Correct answer";
        } else {
            checkStatus.textContent = "‚ùå Incorrect answer";
            if (Array.isArray(data.steps) && data.steps.length) {
                guideSteps = data.steps;
                renderGuideSteps(guideSteps, "Fix Steps");
            }
        }
        await loadScore();
    });

    function renderGuideSteps(steps, title = "Walkthrough") {
        if (!guidePanel) return;
        if (!steps || !steps.length) {
            guidePanel.innerHTML = "<div class=\"text-muted\">No steps available yet.</div>";
            return;
        }
        guidePanel.innerHTML = `
            <div class=\"guide-progress\"><div id=\"guideProgress\"></div></div>
            <div class=\"mb-2\"><strong>${title}</strong></div>
            ${steps.map((step, index) => `
                <div class=\"guide-step\" data-step=\"${index}\">
                    ${index + 1}. ${step}
                </div>
            `).join("")}
        `;
    }

    generateGuideBtn.addEventListener("click", async () => {
        guideStatus.textContent = "Generating...";
        const response = await fetch(`/player/${playerId}/guidance`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ answer: finalAnswerInput.value })
        });
        const data = await response.json();
        if (data.success) {
            guideSteps = data.steps || [];
            guideDurations = Array.isArray(data.durations) ? data.durations : [];
            renderGuideSteps(guideSteps, data.title || "Walkthrough");
            guideStatus.textContent = "";
        } else {
            guideStatus.textContent = data.message || "Unable to generate";
        }
    });

    playGuideBtn.addEventListener("click", () => {
        if (!guideSteps.length) {
            guideStatus.textContent = "Generate a walkthrough first";
            return;
        }
        guideStatus.textContent = "Playing...";
        const stepElements = Array.from(document.querySelectorAll(".guide-step"));
        const progressEl = document.getElementById("guideProgress");
        let index = 0;

        function speakNext() {
            if (index >= guideSteps.length) {
                guideStatus.textContent = "Finished";
                return;
            }
            stepElements.forEach(el => el.classList.remove("active"));
            const activeEl = stepElements[index];
            if (activeEl) activeEl.classList.add("active");

            const durationMs = (guideDurations[index] || 7) * 1000;
            if (progressEl) {
                const percent = Math.min(100, Math.round(((index + 1) / guideSteps.length) * 100));
                progressEl.style.width = `${percent}%`;
            }

            const utterance = new SpeechSynthesisUtterance(guideSteps[index]);
            utterance.onend = () => {
                index += 1;
                speakNext();
            };
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);

            setTimeout(() => {
                if (!speechSynthesis.speaking) {
                    index += 1;
                    speakNext();
                }
            }, durationMs);
        }

        speakNext();
    });

    function appendChatMessage(role, text) {
        if (!chatBox) return;
        const wrapper = document.createElement("div");
        wrapper.className = "chat-message";
        const labelClass = role === "user" ? "chat-user" : "chat-ai";
        const label = role === "user" ? "You" : "AI";
        wrapper.innerHTML = `<div class=\"${labelClass}\">${label}</div><div>${text}</div>`;
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    chatSend.addEventListener("click", async () => {
        const message = chatInput.value.trim();
        if (!message) return;
        appendChatMessage("user", message);
        chatHistory.push({ role: "user", content: message });
        chatInput.value = "";

        const response = await fetch(`/player/${playerId}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message, history: chatHistory })
        });
        const data = await response.json();
        const reply = data.reply || data.message || "No response";
        appendChatMessage("assistant", reply);
        chatHistory.push({ role: "assistant", content: reply });
    });

    saveCompletionBtn.addEventListener("click", async () => {
        checkStatus.textContent = "Saving...";
        const attemptsValue = Number(finalAttemptsInput.value);
        const badgeName = finalBadgeInput.value.trim();
        if (!Number.isFinite(attemptsValue)) {
            checkStatus.textContent = "Enter a valid attempts count";
            return;
        }
        if (!badgeName) {
            checkStatus.textContent = "Enter a badge name";
            return;
        }
        const response = await fetch(`/player/${playerId}/complete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                attempts: attemptsValue,
                badge_name: badgeName,
                timestamp: new Date().toISOString()
            })
        });
        const data = await response.json();
        if (data.success) {
            checkStatus.textContent = "‚úÖ Completion saved";
        } else {
            checkStatus.textContent = data.message || "Error saving completion";
        }
        await loadScore();
    });

    loadScore();
</script>
{% endblock %}
